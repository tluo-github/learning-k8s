# 记一次KUBERNETES/DOCKER网络排障

**案例来源:** https://coolshell.cn/articles/18654.html

** 问题的症状:**
用户直接在微信里说，他们发现在Kuberbnetes下的某个pod被重启了几百次甚至上千次，于是开启调查这个pod，发现上面的服务时而能够访问，时而不能访问，也就是有一定概率不能访问，不知道是什么原因。而且并不是所有的pod出问题，而只是特定的一两个pod出了网络访问的问题。用户说这个pod运行着Java程序，为了排除是Java的问题，用户用 **docker exec -it** 命令直接到容器内启了一个 Python的 SimpleHttpServer来测试发现也是一样的问题。

** 问题初查 **

首先，我们排除了flannel的问题，因为整个集群的网络通信都正常，只有特定的某一两个pod有问题。而用 **telnet ip port** 的命令手工测试网络连接时有很大的概率出现 **connection refused** 错误，大约 1/4的概率，而3/4的情况下是可以正常连接的。

当时，我们让用户抓个包看看，然后，用户抓到了有问题的TCP连接是收到了 SYN 后，立即返回了 **RST, ACK**

![](/images/case-2-tcpdump.png)

我问一下用户这两个IP所在的位置，知道了，**10.233.14.129** 是 **docker0**，**10.233.14.145** 是容器内的IP。所以，这基本上可以排除了所有和kubernets或是flannel的问题，这就是本地的Docker上的网络的问题。

对于这样被直接 Reset 的情况，在 **telnet** 上会显示 **connection refused** 的错误信息，对于我个人的经验，这种 **SYN** 完直接返回 **RST, ACK** 的情况只会有三种情况：

1. TCP链接不能建立，不能建立连接的原因基本上是标识一条TCP链接的那五元组不能完成，绝大多数情况都是服务端没有相关的端口号。
2. TCP链接建错误，有可能是因为修改了一些TCP参数，尤其是那些默认是关闭的参数，因为这些参数会导致TCP协议不完整。
3. 有防火墙iptables的设置，其中有 **REJECT** 规则。(也就是一条 ICMP 回复)





